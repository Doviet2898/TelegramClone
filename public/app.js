// Bi·∫øn to√†n c·ª•c
let currentUser = null;
let currentChat = null;
let socket = null;
let typingTimeout = null;
let users = [];
let messages = {};

// DOM Elements
const authScreen = document.getElementById('auth-screen');
const mainScreen = document.getElementById('main-screen');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const loginError = document.getElementById('login-error');
const registerError = document.getElementById('register-error');
const tabBtns = document.querySelectorAll('.tab-btn');
const currentUsername = document.getElementById('current-username');
const currentUserAvatar = document.getElementById('current-user-avatar');
const usersList = document.getElementById('users-list');
const searchInput = document.getElementById('search-input');
const logoutBtn = document.getElementById('logout-btn');
const avatarInput = document.getElementById('avatar-input');
const emptyChat = document.getElementById('empty-chat');
const chatContainer = document.getElementById('chat-container');
const chatUsername = document.getElementById('chat-username');
const chatUserAvatar = document.getElementById('chat-user-avatar');
const chatStatus = document.getElementById('chat-status');
const messagesContainer = document.getElementById('messages-container');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const typingIndicator = document.getElementById('typing-indicator');

// Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
function checkAuth() {
    const token = localStorage.getItem('token');
    if (token) {
        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
        currentUser = JSON.parse(localStorage.getItem('user'));
        if (currentUser) {
            showMainScreen();
            initSocket();
            return;
        }
    }
    showAuthScreen();
}

// Hi·ªÉn th·ªã m√†n h√¨nh ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
function showAuthScreen() {
    authScreen.classList.remove('hidden');
    mainScreen.classList.add('hidden');
}

// Hi·ªÉn th·ªã m√†n h√¨nh ch√≠nh
function showMainScreen() {
    authScreen.classList.add('hidden');
    mainScreen.classList.remove('hidden');
    updateCurrentUserInfo();
    fetchUsers();
}

// C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
function updateCurrentUserInfo() {
    if (currentUser) {
        currentUsername.textContent = currentUser.username;
        if (currentUser.avatar) {
            currentUserAvatar.src = currentUser.avatar.startsWith('http') 
                ? currentUser.avatar 
                : `/uploads/${currentUser.avatar}`;
        }
    }
}

// Kh·ªüi t·∫°o k·∫øt n·ªëi Socket.IO
function initSocket() {
    socket = io('http://localhost:3000');

    // ƒêƒÉng nh·∫≠p v√†o socket
    socket.emit('login', currentUser.id);

    // L·∫Øng nghe s·ª± ki·ªán tr·∫°ng th√°i ng∆∞·ªùi d√πng thay ƒë·ªïi
    socket.on('userStatusChanged', (data) => {
        updateUserStatus(data.userId, data.status, data.lastSeen);
    });

    // L·∫Øng nghe s·ª± ki·ªán tin nh·∫Øn m·ªõi
    socket.on('newMessage', (message) => {
        if (message.sender === currentChat?.id) {
            addMessageToChat(message, false);
            scrollToBottom();
            // ƒê√°nh d·∫•u tin nh·∫Øn ƒë√£ ƒë·ªçc
            socket.emit('markAsRead', { messageId: message._id });
        } else {
            // TƒÉng s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
            incrementUnreadCount(message.sender);
        }
    });

    // L·∫Øng nghe s·ª± ki·ªán tin nh·∫Øn ƒë√£ g·ª≠i
    socket.on('messageSent', (message) => {
        if (message.receiver === currentChat?.id) {
            addMessageToChat(message, true);
            scrollToBottom();
        }
    });

    // L·∫Øng nghe s·ª± ki·ªán tin nh·∫Øn ƒë√£ ƒë·ªçc
    socket.on('messageRead', (data) => {
        const messageElement = document.getElementById(`message-${data.messageId}`);
        if (messageElement) {
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                statusElement.textContent = 'ƒê√£ xem';
            }
        }
    });

    // L·∫Øng nghe s·ª± ki·ªán ng∆∞·ªùi d√πng ƒëang nh·∫≠p
    socket.on('userTyping', (data) => {
        if (data.userId === currentChat?.id) {
            typingIndicator.classList.remove('hidden');
        }
    });

    // L·∫Øng nghe s·ª± ki·ªán ng∆∞·ªùi d√πng d·ª´ng nh·∫≠p
    socket.on('userStopTyping', (data) => {
        if (data.userId === currentChat?.id) {
            typingIndicator.classList.add('hidden');
        }
    });

    // L·∫Øng nghe s·ª± ki·ªán l·ªói
    socket.on('messageError', (error) => {
        console.error('L·ªói tin nh·∫Øn:', error);
        alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i sau.');
    });
}

// L·∫•y danh s√°ch ng∆∞·ªùi d√πng
async function fetchUsers() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/users', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch ng∆∞·ªùi d√πng');
        }

        users = await response.json();
        renderUsersList(users);
    } catch (error) {
        console.error('L·ªói khi l·∫•y danh s√°ch ng∆∞·ªùi d√πng:', error);
    }
}

// Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi d√πng
function renderUsersList(usersList) {
    const usersListElement = document.getElementById('users-list');
    usersListElement.innerHTML = '';

    usersList.forEach(user => {
        const userElement = document.createElement('div');
        userElement.classList.add('user-item');
        userElement.dataset.userId = user._id;

        // Ki·ªÉm tra n·∫øu ƒë√¢y l√† ng∆∞·ªùi d√πng ƒëang chat
        if (currentChat && user._id === currentChat.id) {
            userElement.classList.add('active');
        }

        userElement.innerHTML = `
            <img src="${user.avatar ? `/uploads/${user.avatar}` : 'default-avatar.png'}" alt="${user.username}">
            <div class="user-item-info">
                <h4>${user.username}</h4>
                <p class="last-message">${getLastMessage(user._id) || 'B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán'}</p>
            </div>
            <div class="user-meta">
                <span class="message-time">${getLastMessageTime(user._id) || ''}</span>
                ${getUnreadBadge(user._id)}
            </div>
        `;

        userElement.addEventListener('click', () => selectChat(user));
        usersListElement.appendChild(userElement);
    });
}

// L·∫•y tin nh·∫Øn cu·ªëi c√πng
function getLastMessage(userId) {
    if (!messages[userId] || messages[userId].length === 0) {
        return null;
    }
    const lastMessage = messages[userId][messages[userId].length - 1];
    if (lastMessage.type === 'image') {
        return 'üñºÔ∏è H√¨nh ·∫£nh';
    }
    return lastMessage.content;
}

// L·∫•y th·ªùi gian tin nh·∫Øn cu·ªëi c√πng
function getLastMessageTime(userId) {
    if (!messages[userId] || messages[userId].length === 0) {
        return null;
    }
    const lastMessage = messages[userId][messages[userId].length - 1];
    return formatTime(new Date(lastMessage.timestamp));
}

// L·∫•y badge s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
function getUnreadBadge(userId) {
    const unreadCount = localStorage.getItem(`unread_${userId}`);
    if (unreadCount && parseInt(unreadCount) > 0) {
        return `<div class="unread-badge">${unreadCount}</div>`;
    }
    return '';
}

// TƒÉng s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
function incrementUnreadCount(userId) {
    let count = parseInt(localStorage.getItem(`unread_${userId}`) || '0');
    count++;
    localStorage.setItem(`unread_${userId}`, count.toString());
    renderUsersList(users);
}

// X√≥a s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
function clearUnreadCount(userId) {
    localStorage.removeItem(`unread_${userId}`);
}

// Ch·ªçn ng∆∞·ªùi d√πng ƒë·ªÉ chat
async function selectChat(user) {
    // C·∫≠p nh·∫≠t UI
    const userItems = document.querySelectorAll('.user-item');
    userItems.forEach(item => item.classList.remove('active'));
    const selectedItem = document.querySelector(`.user-item[data-user-id="${user._id}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }

    // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng ƒëang chat
    currentChat = {
        id: user._id,
        username: user.username,
        avatar: user.avatar,
        status: user.status
    };

    // Hi·ªÉn th·ªã khu v·ª±c chat
    emptyChat.classList.add('hidden');
    chatContainer.classList.remove('hidden');

    // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng trong header chat
    chatUsername.textContent = user.username;
    chatUserAvatar.src = user.avatar ? `/uploads/${user.avatar}` : 'default-avatar.png';
    chatStatus.textContent = user.status === 'online' ? 'Online' : 'Offline';
    chatStatus.className = 'status';
    if (user.status === 'online') {
        chatStatus.classList.add('online');
    }

    // X√≥a s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc
    clearUnreadCount(user._id);

    // L·∫•y l·ªãch s·ª≠ tin nh·∫Øn
    await fetchMessages(user._id);
}

// L·∫•y l·ªãch s·ª≠ tin nh·∫Øn
async function fetchMessages(userId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/messages/${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y l·ªãch s·ª≠ tin nh·∫Øn');
        }

        const fetchedMessages = await response.json();
        messages[userId] = fetchedMessages;

        // Hi·ªÉn th·ªã tin nh·∫Øn
        renderMessages(fetchedMessages);

        // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
        scrollToBottom();

        // ƒê√°nh d·∫•u t·∫•t c·∫£ tin nh·∫Øn l√† ƒë√£ ƒë·ªçc
        fetchedMessages.forEach(message => {
            if (!message.isRead && message.sender === userId) {
                socket.emit('markAsRead', { messageId: message._id });
            }
        });
    } catch (error) {
        console.error('L·ªói khi l·∫•y l·ªãch s·ª≠ tin nh·∫Øn:', error);
    }
}

// Hi·ªÉn th·ªã tin nh·∫Øn
function renderMessages(messagesList) {
    messagesContainer.innerHTML = '';

    messagesList.forEach(message => {
        const isSent = message.sender === currentUser.id;
        addMessageToChat(message, isSent);
    });
}

// Th√™m tin nh·∫Øn v√†o khu v·ª±c chat
function addMessageToChat(message, isSent) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-bubble');
    messageElement.classList.add(isSent ? 'sent' : 'received');
    messageElement.id = `message-${message._id}`;

    let messageContent = '';
    if (message.type === 'image') {
        messageContent = `<img src="${message.fileUrl}" alt="H√¨nh ·∫£nh" class="message-image">`;
    } else {
        messageContent = message.content;
    }

    messageElement.innerHTML = `
        <div class="message-content">${messageContent}</div>
        <div class="message-info">
            <span class="message-time">${formatTime(new Date(message.timestamp))}</span>
            ${isSent ? `<span class="message-status">${message.isRead ? 'ƒê√£ xem' : 'ƒê√£ g·ª≠i'}</span>` : ''}
        </div>
    `;

    messagesContainer.appendChild(messageElement);
}

// Cu·ªôn xu·ªëng d∆∞·ªõi c√πng khu v·ª±c chat
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ƒê·ªãnh d·∫°ng th·ªùi gian
function formatTime(date) {
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng
function updateUserStatus(userId, status, lastSeen) {
    // C·∫≠p nh·∫≠t trong danh s√°ch ng∆∞·ªùi d√πng
    const userIndex = users.findIndex(user => user._id === userId);
    if (userIndex !== -1) {
        users[userIndex].status = status;
        users[userIndex].lastSeen = lastSeen;
        renderUsersList(users);
    }

    // C·∫≠p nh·∫≠t trong khu v·ª±c chat n·∫øu ƒëang chat v·ªõi ng∆∞·ªùi d√πng n√†y
    if (currentChat && currentChat.id === userId) {
        chatStatus.textContent = status === 'online' ? 'Online' : 'Offline';
        chatStatus.className = 'status';
        if (status === 'online') {
            chatStatus.classList.add('online');
        }
    }
}

// G·ª≠i tin nh·∫Øn
function sendMessage() {
    const content = messageInput.value.trim();
    if (!content) return;

    // G·ª≠i tin nh·∫Øn qua socket
    socket.emit('sendMessage', {
        senderId: currentUser.id,
        receiverId: currentChat.id,
        content,
        type: 'text'
    });

    // X√≥a n·ªôi dung input
    messageInput.value = '';
    messageInput.focus();

    // D·ª´ng tr·∫°ng th√°i ƒëang nh·∫≠p
    stopTyping();
}

// G·ª≠i h√¨nh ·∫£nh
async function sendImage(file) {
    try {
        const formData = new FormData();
        formData.append('image', file);

        const token = localStorage.getItem('token');
        const response = await fetch('/api/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i l√™n h√¨nh ·∫£nh');
        }

        const data = await response.json();

        // G·ª≠i tin nh·∫Øn h√¨nh ·∫£nh qua socket
        socket.emit('sendMessage', {
            senderId: currentUser.id,
            receiverId: currentChat.id,
            content: 'H√¨nh ·∫£nh',
            type: 'image',
            fileUrl: data.fileUrl
        });
    } catch (error) {
        console.error('L·ªói khi t·∫£i l√™n h√¨nh ·∫£nh:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i l√™n h√¨nh ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
}

// C·∫≠p nh·∫≠t avatar
async function updateAvatar(file) {
    try {
        const formData = new FormData();
        formData.append('avatar', file);

        const token = localStorage.getItem('token');
        const response = await fetch('/api/update-avatar', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t avatar');
        }

        const data = await response.json();

        // C·∫≠p nh·∫≠t avatar trong localStorage
        currentUser.avatar = data.avatar;
        localStorage.setItem('user', JSON.stringify(currentUser));

        // C·∫≠p nh·∫≠t UI
        currentUserAvatar.src = `/uploads/${data.avatar}`;
    } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t avatar:', error);
        alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t avatar. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
}

// X·ª≠ l√Ω ƒëang nh·∫≠p
function handleTyping() {
    if (!socket || !currentChat) return;

    // G·ª≠i s·ª± ki·ªán ƒëang nh·∫≠p
    socket.emit('typing', {
        senderId: currentUser.id,
        receiverId: currentChat.id
    });

    // X√≥a timeout c≈© n·∫øu c√≥
    if (typingTimeout) {
        clearTimeout(typingTimeout);
    }

    // ƒê·∫∑t timeout m·ªõi
    typingTimeout = setTimeout(stopTyping, 2000);
}

// D·ª´ng tr·∫°ng th√°i ƒëang nh·∫≠p
function stopTyping() {
    if (!socket || !currentChat) return;

    // G·ª≠i s·ª± ki·ªán d·ª´ng nh·∫≠p
    socket.emit('stopTyping', {
        senderId: currentUser.id,
        receiverId: currentChat.id
    });

    // X√≥a timeout
    if (typingTimeout) {
        clearTimeout(typingTimeout);
        typingTimeout = null;
    }
}

// ƒêƒÉng nh·∫≠p
async function login(username, password) {
    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
        }

        // L∆∞u token v√† th√¥ng tin ng∆∞·ªùi d√πng
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));

        // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
        currentUser = data.user;

        // Hi·ªÉn th·ªã m√†n h√¨nh ch√≠nh
        showMainScreen();

        // Kh·ªüi t·∫°o k·∫øt n·ªëi socket
        initSocket();

        return true;
    } catch (error) {
        console.error('L·ªói ƒëƒÉng nh·∫≠p:', error);
        return error.message;
    }
}

// ƒêƒÉng k√Ω
async function register(username, password) {
    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i');
        }

        return true;
    } catch (error) {
        console.error('L·ªói ƒëƒÉng k√Ω:', error);
        return error.message;
    }
}

// ƒêƒÉng xu·∫•t
function logout() {
    // X√≥a token v√† th√¥ng tin ng∆∞·ªùi d√πng
    localStorage.removeItem('token');
    localStorage.removeItem('user');

    // Ng·∫Øt k·∫øt n·ªëi socket
    if (socket) {
        socket.disconnect();
    }

    // Reset bi·∫øn to√†n c·ª•c
    currentUser = null;
    currentChat = null;
    socket = null;
    users = [];
    messages = {};

    // Hi·ªÉn th·ªã m√†n h√¨nh ƒëƒÉng nh·∫≠p
    showAuthScreen();
}

// T√¨m ki·∫øm ng∆∞·ªùi d√πng
function searchUsers(query) {
    if (!query) {
        renderUsersList(users);
        return;
    }

    const filteredUsers = users.filter(user => 
        user.username.toLowerCase().includes(query.toLowerCase())
    );
    renderUsersList(filteredUsers);
}

// Event Listeners

// Chuy·ªÉn tab ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const tabName = btn.dataset.tab;
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.remove('active');
        });
        document.getElementById(`${tabName}-form`).classList.add('active');
    });
});

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;

    if (!username || !password) {
        loginError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin';
        return;
    }

    loginError.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
    const result = await login(username, password);

    if (result !== true) {
        loginError.textContent = result;
    }
});

// X·ª≠ l√Ω ƒëƒÉng k√Ω
registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;

    if (!username || !password || !confirmPassword) {
        registerError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin';
        return;
    }

    if (password !== confirmPassword) {
        registerError.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
        return;
    }

    registerError.textContent = 'ƒêang ƒëƒÉng k√Ω...';
    const result = await register(username, password);

    if (result === true) {
        registerError.textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.';
        registerError.style.color = '#2ecc71';

        // Chuy·ªÉn sang tab ƒëƒÉng nh·∫≠p
        setTimeout(() => {
            document.querySelector('[data-tab="login"]').click();
            registerError.textContent = '';
            registerError.style.color = '';
        }, 2000);
    } else {
        registerError.textContent = result;
    }
});

// X·ª≠ l√Ω ƒëƒÉng xu·∫•t
logoutBtn.addEventListener('click', logout);

// X·ª≠ l√Ω g·ª≠i tin nh·∫Øn
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

// X·ª≠ l√Ω ƒëang nh·∫≠p
messageInput.addEventListener('input', handleTyping);

// X·ª≠ l√Ω t√¨m ki·∫øm ng∆∞·ªùi d√πng
searchInput.addEventListener('input', (e) => {
    searchUsers(e.target.value.trim());
});

// X·ª≠ l√Ω t·∫£i l√™n h√¨nh ·∫£nh
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        sendImage(e.target.files[0]);
        e.target.value = '';
    }
});

// X·ª≠ l√Ω c·∫≠p nh·∫≠t avatar
avatarInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        updateAvatar(e.target.files[0]);
        e.target.value = '';
    }
});

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
checkAuth();

// Th√™m ·∫£nh avatar m·∫∑c ƒë·ªãnh
const defaultAvatar = document.createElement('img');
defaultAvatar.src = 'default-avatar.png';
defaultAvatar.style.display = 'none';
document.body.appendChild(defaultAvatar);